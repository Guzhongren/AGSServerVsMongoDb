{
  "name": "AgsServerVSMongodb",
  "tagline": "AGSServerVsMongoDb",
  "body": "#  ArcGIS for Server VS MongoDb\r\n## 目录\r\n1. 总体效果展示\r\n2. JSON数据生产\r\n3. JSON导入MongoDb\r\n4. Node+Express+Bootstrap\r\n5. 运行\r\n6. 结论\r\n\r\n***\r\n\r\n### 1.总体效果展示\r\n\r\n![性能效果图](截图/ServerVSMongoDb.gif)\r\n\r\n### 2.JSON数据生产\r\n###### 2.1 数据\r\n    数据如下图：兰州市POI点\r\n![兰州POI](截图/lanzhouPOI.png)\r\n\r\n###### 2.2转换为JSON\r\n    使用ArcGIS提供的Features to JSON工具进行转换\r\n![要素转JSON](截图/featurestojson.png)\r\n\r\n### 3.JSON导入MongoDb\r\n######  3.1 导入MongoDb\r\n    用Node.js编写Node.js读取JSON文件并将其按照要素格式存入MongoDb中\r\n```javascript\r\n //features 表创建及document插入\r\ndb.createCollection('features', {safe: true}, function(err, collection){\r\n    if(err){\r\n        throw err;\r\n    }else {\r\n        jsonObj.features.forEach(function(value, key){\r\n            var temp= {key: value};\r\n            collection.insert(temp, {safe: true}, function(err, result){\r\n                console.log(result);\r\n            });\r\n            temp= null;\r\n        });\r\n\r\n    }\r\n});\r\n```\r\n###### 3.2 MongoDb中显示\r\n    在MongoDb中插入后，查询所有数据显示如下：\r\n![MongoDbPOI](截图/POI数据.png)\r\n\r\n### 4.Node+Express+Bootstrap\r\n###### 4.1 项目结构\r\n![项目结构](截图/项目结构.png)\r\n###### 4.2 页面部分\r\n```html\r\n<body>\r\n  <nav class=\"navbar navbar-default navbar-fixed-top\" role=\"navigation\">\r\n    <div class=\"navbar-header\">\r\n        <a class=\"navbar-brand\" href=\"#\">AGS Server vs MongoDB</a>\r\n    </div>\r\n    <div>\r\n        <p class=\"navbar-text navbar-right\">Signed in as\r\n          <a href=\"#\" class=\"navbar-link\">Thomas</a>\r\n        </p>\r\n    </div>\r\n  </nav>\r\n  <div class=\"container-fluid\">\r\n  <h1 class=\"center\"><%= Servertitle %> vs <%= MongoDBTitle%></h1>\r\n  <h4 class=\"center\">本例针对有59003个兰州市的POI点的要素数据进行属性和空间查询性能对比</h4>\r\n  <h4 class=\"center\"> Tested by 谷中仁 </h4>\r\n    <div class=\"row\">\r\n      <!-----------------------------属性查询对比部分--------------------->\r\n      <div class=\"col-md-12\">\r\n        <h1 class=\"center\">属性查询</h1>\r\n        <table id=\"serverTable\" class=\"table table-striped table-bordered table-hover table-condensed\">\r\n          <caption>对随机要素\r\n            <select id=\"poiInfo\" class=\"selectpicker\" data-style=\"btn btn-success\">\r\n              <option value=\"鸿运旅馆(兰州雁滩路店)\">鸿运旅馆(兰州雁滩路店)</option>\r\n              <option value=\"双裕牛肉拉面全国连锁\">双裕牛肉拉面全国连锁</option>\r\n              <option value=\"旋子清真寺(西南门)\">旋子清真寺(西南门)</option>\r\n              <option value=\"兰州大学榆中校区办公楼\">兰州大学榆中校区办公楼</option>\r\n              <option value=\"北灵观真武殿\">北灵观真武殿</option>\r\n              <option value=\"秦王川\">秦王川</option>\r\n              <option value=\"兰州汇昌物资石化有限公司(安宁区店)\">兰州汇昌物资石化有限公司(安宁区店)</option>\r\n              <option value=\"视康眼镜(中共金崖镇纪律检查委员会西)\">视康眼镜(中共金崖镇纪律检查委员会西)</option>\r\n              <option value=\"中国人民财产保险有限公司\">中国人民财产保险有限公司</option>\r\n              <option value=\"小西湖新华厂家属院92㎡\">小西湖新华厂家属院92㎡</option>\r\n              <option value=\"榆中邮政局麻家寺储蓄所\">榆中邮政局麻家寺储蓄所</option>\r\n              <option value=\"兰州石化公司离岗退养职工活动中心\">兰州石化公司离岗退养职工活动中心</option>\r\n              <option value=\"兰塑塑业有限责任公司医务所\">兰塑塑业有限责任公司医务所</option>\r\n              <option value=\"兰州市西固区安监局\">兰州市西固区安监局</option>\r\n              <option value=\"兰州万达文华酒店\">兰州万达文华酒店</option>\r\n            </select>\r\n            进行测试;<h3 class=\"focused\">一般结论：属性查询方面，MongoDb完胜AGS Server</h3></caption>\r\n          <thread>\r\n            <tr>\r\n              <th>序号</th>\r\n              <th>所选数据</th>\r\n              <th>Server开始时间</th>\r\n              <th>Server结束时间</th>\r\n              <th>Server耗时(ms)</th>\r\n              <th>MongoDB开始时间</th>\r\n              <th>MongoDB结束时间</th>\r\n              <th>MongoDB耗时(ms)</th>\r\n              <th class=\"focused\">MongoDB-Server时差（ms）</th>\r\n            </tr>\r\n          </thread>\r\n          <tbody id=\"attr\">\r\n\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n\r\n      <!-------------------------------------------------空间查询部分 ------------------------------->\r\n      <div class=\"col-md-12\">\r\n          <h1 class=\"center\">空间查询</h1>\r\n          <div id=\"map\"></div>\r\n          <table id=\"spatialTable\" class=\"table table-striped table-bordered table-hover table-condensed\">\r\n              <caption>\r\n                  <h5>随机点半径100m查询；黑圈代表MongoDb查询结果，粉红色实心圆代表AGS Server查询结果。</h5>\r\n                  <h5 class=\"focused\">因为MongoDb查询单位是mile，转换为meter有误差，所以MongoDb查询结果较AGS Server少</h5>\r\n                  <h3 class=\"focused\">一般结论：空间查询方面，Server更甚一筹</h3>\r\n              </caption>\r\n              <thread>\r\n                  <tr>\r\n                      <th>序号</th>\r\n                      <th>Server开始时间</th>\r\n                      <th>Server结束时间</th>\r\n                      <th>Server耗时(ms)</th>\r\n                      <th>Server查询结果数</th>\r\n                      <th>MongoDB开始时间</th>\r\n                      <th>MongoDB结束时间</th>\r\n                      <th>MongoDB耗时(ms)</th>\r\n                      <th>MongoDb查询结果数</th>\r\n                      <th class=\"focused\">MongoDB-Server时差（ms）</th>\r\n                      <th class=\"focused\">MongoDb-Server结果数（个）</th>\r\n                  </tr>\r\n              </thread>\r\n          <tbody id=\"spatialAttr\">\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</body>\r\n```\r\n##### 4.3 REST接口设计\r\n```javascript\r\nrouter.get('/getInfoByName', function(req, res, next){\r\n\r\n    queryByName(req.query.name).then(function(data){\r\n        res.send(data);\r\n    }, function(err){\r\n        res.send(err);\r\n    });\r\n});\r\n\r\n/**\r\n * 查询某点范围某多少距离范围内含有的点\r\n * localhost:3000/getNear?x=104&y=36&distance=2\r\n * @param {Number}  x   经度\r\n * @param {Number}  y   纬度\r\n * @param {Number}  distance    距离\r\n * @return {json}  \r\n */\r\nrouter.get(\"/getNear\", function(req, res, next){\r\n    //转换单位\r\n\r\n    var x= parseFloat(req.query.x);\r\n    var y= parseFloat(req.query.y);\r\n    //1 英里 = 5 280 英尺 = 63 360 英寸 = 1 609.344 米 = 1760 码 = 1.609344千 米=1.609344公里\r\n    var distance= parseFloat(req.query.distance/ 160900.344);//\r\n    findNearLocations(x, y, parseFloat(distance)).then(data=>{\r\n        res.send(data);\r\n    }, err=>{\r\n        res.send(err);\r\n    })\r\n});\r\n```\r\n###### 4.4 计时设计\r\n```javascript\r\nmap.on(\"click\", function(evt){\r\n    //server开始时间\r\n    serverStartTime = new Date();\r\n    j++;//序号\r\n    clickPoint = {\"x\": evt.mapPoint.getLongitude(),\r\n                  \"y\": evt.mapPoint.getLatitude()};\r\n  circle = new Circle({\r\n    center: evt.mapPoint,\r\n    geodesic: true,\r\n    radius: 100\r\n    // radiusUnit: \"esriMiles\"\r\n  });\r\n  map.graphics.clear();\r\n  map.infoWindow.hide();\r\n  var graphic = new Graphic(circle, circleSymb);\r\n  map.graphics.add(graphic);\r\n  var query = new Query();\r\n  query.geometry = circle.getExtent();\r\n  featureLayer.queryFeatures(query, selectInBuffer);\r\n});\r\nfunction selectInBuffer(response){\r\n    serverEndTime = new Date();\r\n    serverTimeSpan = serverEndTime - serverStartTime;\r\n    serverCount = response.features.length;\r\n    mongoStartTime = new Date();\r\n     //===================================MongoDb开始===================================\r\n     var url = \"http://localhost:3000/getNear\";\r\n     var data = {\r\n        \"x\" : clickPoint.x,\r\n        \"y\" : clickPoint.y,\r\n        \"distance\" : 100\r\n    };\r\n    $.get(url, data, function(response, status){\r\n        mongoEndTime = new Date();\r\n        mongoTimeSpan = mongoEndTime - mongoStartTime;\r\n        mongoCount = response.result.length;\r\n        console.log(response);\r\n        var mongoSymbol = new SimpleMarkerSymbol();\r\n        var infoTemplate = new InfoTemplate(\"MongoDb结果\",\"MongoDb结果\")\r\n        if(response.result.length> 0){\r\n            for(var index in response.result){\r\n                var mongoPoint = new Point([response.result[index].key.geometry.x, response.result[index].key.geometry.y]);\r\n                var graphic= new Graphic(mongoPoint, mongoSymbol, null, infoTemplate);\r\n                map.graphics.add(graphic);\r\n                graphic = null;\r\n            }\r\n        }\r\n        var mongoVsServerTime= mongoTimeSpan- serverTimeSpan;\r\n        var mongVsServerCount= mongoCount - serverCount;\r\n        //控制显示\r\n        var html = '';\r\n        html +='<tr>';\r\n        html +='<td>'+ j +'</td>';\r\n        html +='<td>'+ serverStartTime.toLocaleTimeString() +'</td>';\r\n        html +='<td>'+ serverEndTime.toLocaleTimeString() +'</td>';\r\n        html +='<td>'+ serverTimeSpan +'</td>';\r\n        html +='<td>'+ serverCount +'</td>';\r\n        html +='<td>'+ mongoStartTime.toLocaleTimeString() +'</td>';\r\n        html +='<td>'+ mongoEndTime.toLocaleTimeString() +'</td>';\r\n        html +='<td>'+ mongoTimeSpan +'</td>';\r\n        html +='<td>'+ mongoCount +'</td>';\r\n        html +='<td class=\"focused\">'+ mongoVsServerTime +'</td>';\r\n        html +='<td class=\"focused\">'+ mongVsServerCount +'</td>';\r\n        html +='</tr>';\r\n        domConstruct.place(html, \"spatialAttr\", \"last\");\r\n        html =null;\r\n    });\r\n```\r\n### 5.运行\r\n    在CMD中进入项目目录\r\n```shell\r\n> cd  ~/.ServerVsMongoDb\r\n> node bin/www\r\n```\r\n    打开浏览器进入localhost:3000，效果在最前面......\r\n\r\n### 6.总结\r\n    从最上面的gif图中可以看出，对于5W条数据，属性查询方面MongoDb比ArcGIS for\r\n    Server 的查询速度快；而空间查询方面，ArcGIS for Server较快。因为MongoDb\r\n    空间查询使用的是mile，在转换为meter的过程中会有误差，所以MongoDb的查询结\r\n    果会少于Server的查询数量。\r\n\r\n    但是，MongoDb对数据不能分析，空间数据的价值就在于空间分析，让数据说话，而\r\n    不是仅仅让数据只用于存储数据。\r\n\r\n    对于MongoDb更适合于做LBS应用，可以利用MongoDb和一些开源的地图框架就可实现\r\n    GIS数据上图；对于ArcGIS for Server，其主要优势是空间查询和空间分析，对于\r\n    有强GIS需求的项目则是一种更好的选择。\r\n\r\n    MonogoDB使用简单、安全性高，性能优越，现在，很多应用系统都采用了MongoDB作\r\n    为数据库，由此实现可实现文件存储系统、大数据解决方案、智能打车关键业务等等，\r\n    MonogoDB受到越来越多的人和企业的欢迎。\r\n\r\n关于此文更早的信息详见[MongoDb与ArcGIS for Server属性查询与空间查询-前期](http://mp.weixin.qq.com/s?__biz=MzI3ODM2ODU0Mw==&mid=2247483687&idx=1&sn=a3925b800c64f8665e7a08b8b585d93b&scene=4#wechat_redirect)\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}